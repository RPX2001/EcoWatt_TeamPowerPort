# üöÄ EcoWatt Setup Guide

Complete installation and configuration guide for the EcoWatt system.

---

## Table of Contents

- [Prerequisites](#prerequisites)
- [Quick Setup](#quick-setup)
- [Detailed Setup](#detailed-setup)
- [Configuration](#configuration)
- [Troubleshooting](#troubleshooting)

---

## Prerequisites

### Required Software

| Software | Version | Purpose | Installation |
|:---------|:--------|:--------|:-------------|
| **Python** | 3.10+ | Backend server | [python.org](https://python.org) |
| **Node.js** | 20+ | Frontend development | [nodejs.org](https://nodejs.org) |
| **PlatformIO** | Latest | ESP32 firmware | `pip install platformio` |
| **Just** | Latest | Task automation | [github.com/casey/just](https://github.com/casey/just) |

### Optional Software

- **Git**: Version control
- **VS Code**: Recommended IDE with Platform Extension
- **Postman**: API testing

### Hardware Requirements

- **ESP32-WROOM-32** development board
- **RS485 to TTL** converter module
- **Solar inverter** with Modbus RTU support
- **USB cable** for programming
- **Power supply** (5V, 1A minimum)

---

## Quick Setup

### One-Command Installation

```bash
# Clone repository
git clone https://github.com/RPX2001/EcoWatt_TeamPowerPort.git
cd EcoWatt_TeamPowerPort

# Complete setup (installs all dependencies)
just setup

# Verify installation
just status
```

This installs:
- Python dependencies for Flask backend
- Node.js dependencies for React frontend
- PlatformIO toolchain for ESP32

---

## Detailed Setup

### 1. Backend Setup (Flask)

```bash
cd flask

# Create virtual environment
python3 -m venv venv

# Activate virtual environment
# On macOS/Linux:
source venv/bin/activate
# On Windows:
# venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Generate security keys
python scripts/generate_keys.py

# Initialize database
python database.py init

# Start server
python flask_server_modular.py
```

**Expected Output**:
```
 * Running on http://0.0.0.0:5001
 * Database initialized successfully
 * MQTT connection established
```

### 2. Frontend Setup (React)

```bash
cd front-end

# Install dependencies
npm install

# Start development server
npm run dev
```

**Expected Output**:
```
  VITE v5.0.0  ready in 1234 ms

  ‚ûú  Local:   http://localhost:5173/
  ‚ûú  Network: http://192.168.1.100:5173/
```

### 3. ESP32 Firmware Setup

```bash
cd PIO/ECOWATT

# Configure WiFi credentials
# Edit include/application/credentials.h:
nano include/application/credentials.h
```

**credentials.h**:
```cpp
#ifndef CREDENTIALS_H
#define CREDENTIALS_H

// WiFi Configuration
#define WIFI_SSID "YourWiFiNetwork"
#define WIFI_PASSWORD "YourWiFiPassword"

// Server Configuration
#define SERVER_IP "192.168.1.100"  // Your server IP
#define SERVER_PORT 5001

// Device Configuration
#define DEVICE_ID "ESP32_001"

#endif
```

```bash
# Build firmware
pio run

# Upload to ESP32
pio run --target upload

# Monitor serial output
pio device monitor
```

**Expected Serial Output**:
```
[INFO] WiFi connected: 192.168.1.150
[INFO] Server connection successful
[INFO] Modbus initialized
[INFO] System ready
```

---

## Configuration

### Backend Configuration

**flask/config.py** (create if not exists):

```python
# Server Configuration
HOST = '0.0.0.0'
PORT = 5001
DEBUG = False

# Database Configuration
DATABASE_PATH = 'ecowatt.db'

# MQTT Configuration
MQTT_BROKER = 'broker.hivemq.com'
MQTT_PORT = 1883
MQTT_TOPIC_PREFIX = 'ecowatt/'

# Security Configuration
HMAC_KEY = '5a7b3c9d2e4f1a6b...'  # Generated by generate_keys.py
SESSION_SECRET = 'your-secret-key-here'

# FOTA Configuration
FIRMWARE_DIR = 'firmware/'
CHUNK_SIZE = 2048  # 2KB chunks
```

### Frontend Configuration

**front-end/.env**:

```env
VITE_API_URL=http://localhost:5001
VITE_WS_URL=ws://localhost:5001/ws
VITE_MQTT_BROKER=broker.hivemq.com
VITE_MQTT_PORT=1883
```

### ESP32 Configuration

**platformio.ini**:

```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

# Serial Monitor
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

# Build Flags
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_RUNNING_CORE=1
    -DARDUINO_EVENT_RUNNING_CORE=1

# Upload Settings
upload_speed = 921600
upload_port = /dev/cu.usbserial-*

# Libraries
lib_deps = 
    bblanchon/ArduinoJson@^6.21.0
    4-20ma/ModbusMaster@^2.0.1
    mathieucarbou/mbedTLS@^3.4.0
```

---

## Network Configuration

### Finding Your Server IP

**macOS/Linux**:
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

**Windows**:
```cmd
ipconfig | findstr IPv4
```

### Port Forwarding (Optional)

If accessing from outside local network:

1. Forward port 5001 on your router
2. Update ESP32 with public IP
3. Configure firewall rules
4. Consider using DDNS service

### Firewall Configuration

**Allow Flask server**:
```bash
# macOS
sudo pfctl -e
sudo pfctl -f /etc/pf.conf

# Linux (ufw)
sudo ufw allow 5001/tcp
sudo ufw enable

# Windows
# Add inbound rule in Windows Defender Firewall
```

---

## Security Setup

### 1. Generate Cryptographic Keys

```bash
cd flask
python scripts/generate_keys.py
```

This generates:
- `keys/private_key.pem`: RSA private key (server)
- `keys/public_key.pem`: RSA public key (ESP32)
- `keys/hmac_key.txt`: HMAC shared secret
- `keys/keys.h`: C header file for ESP32

### 2. Install Keys on ESP32

```bash
# Copy generated keys.h to ESP32 project
cp keys/keys.h ../PIO/ECOWATT/include/application/keys.h

# Rebuild firmware with keys
cd ../PIO/ECOWATT
pio run --target upload
```

### 3. Configure HTTPS (Production)

For production deployment with HTTPS:

```bash
# Generate self-signed certificate
openssl req -x509 -newkey rsa:4096 -nodes \
  -out cert.pem -keyout key.pem -days 365

# Update Flask to use SSL
app.run(host='0.0.0.0', port=5001, 
        ssl_context=('cert.pem', 'key.pem'))
```

---

## Database Setup

### Initialize Database

```bash
cd flask
python database.py init
```

### Backup Database

```bash
just db-backup
# Creates: backups/ecowatt_YYYYMMDD_HHMMSS.db
```

### Reset Database

```bash
python database.py reset
# WARNING: Deletes all data!
```

---

## Testing Setup

### Backend Tests

```bash
cd flask
pytest tests/ -v
```

### ESP32 Tests

```bash
cd PIO/ECOWATT
pio test -e esp32dev
```

### Frontend Tests

```bash
cd front-end
npm test
```

---

## Troubleshooting

### Common Issues

#### ESP32 Won't Connect to WiFi

**Symptoms**: `[ERROR] WiFi connection failed`

**Solutions**:
1. Check SSID and password in `credentials.h`
2. Ensure 2.4GHz WiFi (ESP32 doesn't support 5GHz)
3. Check WiFi signal strength
4. Disable MAC address filtering

```cpp
// Add debug output
Serial.println("SSID: " + String(WIFI_SSID));
Serial.println("Connecting...");
```

#### Server Connection Refused

**Symptoms**: `[ERROR] Server connection failed: -1`

**Solutions**:
1. Verify server IP address
2. Check server is running: `curl http://SERVER_IP:5001/api/health`
3. Check firewall rules
4. Verify network connectivity: `ping SERVER_IP`

#### HMAC Validation Failed

**Symptoms**: Server rejects packets with "Invalid HMAC"

**Solutions**:
1. Ensure HMAC keys match on ESP32 and server
2. Regenerate keys: `python scripts/generate_keys.py`
3. Rebuild and reflash ESP32 firmware
4. Check clock synchronization

#### Compilation Errors

**Symptoms**: `fatal error: keys.h: No such file or directory`

**Solutions**:
```bash
# Generate keys first
cd flask
python scripts/generate_keys.py

# Copy to ESP32 project
cp keys/keys.h ../PIO/ECOWATT/include/application/
```

#### Port Already in Use

**Symptoms**: `Address already in use`

**Solutions**:
```bash
# Find process using port 5001
lsof -i :5001

# Kill process
kill -9 <PID>

# Or use different port in config.py
PORT = 5002
```

---

## Production Deployment

### Docker Deployment (Recommended)

```dockerfile
# Dockerfile
FROM python:3.10-slim

WORKDIR /app
COPY flask/ ./

RUN pip install -r requirements.txt

EXPOSE 5001
CMD ["python", "flask_server_modular.py"]
```

```bash
# Build and run
docker build -t ecowatt-server .
docker run -d -p 5001:5001 ecowatt-server
```

### Systemd Service (Linux)

```ini
# /etc/systemd/system/ecowatt.service
[Unit]
Description=EcoWatt Server
After=network.target

[Service]
Type=simple
User=ecowatt
WorkingDirectory=/opt/ecowatt/flask
ExecStart=/opt/ecowatt/venv/bin/python flask_server_modular.py
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# Enable and start
sudo systemctl enable ecowatt
sudo systemctl start ecowatt
sudo systemctl status ecowatt
```

---

## Next Steps

1. **Configure Modbus**: Connect ESP32 to solar inverter
2. **Test Communication**: Verify data flow end-to-end
3. **Customize Dashboard**: Modify React components for your needs
4. **Set Up Monitoring**: Configure alerts and notifications
5. **Plan Maintenance**: Schedule backups and updates

---

## Useful Commands

```bash
# Complete workflow
just setup      # Initial setup
just s          # Start backend
just d          # Start frontend (new terminal)
just f          # Flash ESP32
just m          # Monitor ESP32

# Development
just clean      # Clean build artifacts
just test-all   # Run all tests
just db-backup  # Backup database

# Troubleshooting
just status     # Check system status
just logs       # View server logs
```

---

[‚Üê Back to Main README](../README.md)
