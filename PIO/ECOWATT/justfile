# ESP32 EcoWatt Justfile
# Build and test automation for PlatformIO project
# Usage: just <recipe>

# Use local PlatformIO installation
pio := "~/.platformio/penv/bin/platformio"

# Default recipe - list all commands
default:
    @just --list

# Build firmware for ESP32
build:
    {{pio}} run

# Upload firmware to device
upload:
    {{pio}} run --target upload

# Clean build artifacts
clean:
    {{pio}} run --target clean
    rm -rf .pio/build

# Run all unit tests
test:
    {{pio}} test

# Run specific test suites
test-diagnostics:
    {{pio}} test --filter test_diagnostics*

test-compression:
    {{pio}} test --filter test_compression*

test-aggregation:
    {{pio}} test --filter test_aggregation*

test-security:
    {{pio}} test --filter test_security*

test-protocol:
    {{pio}} test --filter test_protocol*

# Run all tests with verbose output
test-verbose:
    {{pio}} test -v

# Build with diagnostics enabled
build-with-diagnostics:
    {{pio}} run -D ENABLE_DIAGNOSTICS=1

# Build for Wokwi simulator
build-wokwi:
    {{pio}} run -e wokwi

# Run Wokwi simulator (requires VS Code Wokwi extension)
# Open VS Code, press F1, type "Wokwi: Start Simulator"
# Or use: code --open-url "vscode://wokwi.wokwi-vscode/start"
run-wokwi: build-wokwi
    @echo "‚úÖ Firmware built successfully!"
    @echo ""
    @echo "üì± To run in Wokwi simulator:"
    @echo "   1. Make sure VS Code Wokwi extension is installed"
    @echo "   2. Press F1 in VS Code"
    @echo "   3. Type 'Wokwi: Start Simulator'"
    @echo ""
    @echo "Or open the simulation directly in your browser:"
    @echo "   https://wokwi.com/vscode"
    @echo ""
    @echo "Firmware location: .pio/build/wokwi/firmware.bin"

# Monitor serial output
monitor:
    {{pio}} device monitor --baud 115200

# Upload and immediately monitor
flash-monitor: upload
    platformio device monitor --baud 115200

# Format code with clang-format
format:
    find src/ include/ -name "*.cpp" -o -name "*.h" | xargs clang-format -i --style=Google

# Run static analysis
lint:
    @echo "Running cppcheck..."
    cppcheck src/ include/ --enable=warning,performance,portability --suppress=missingIncludeSystem
    @echo "‚úÖ Lint complete"

# Check code size
size:
    platformio run --target size

# Generate documentation with Doxygen
docs:
    @if [ -f Doxyfile ]; then \
        doxygen Doxyfile; \
        echo "‚úÖ Documentation generated in docs/html/"; \
    else \
        echo "‚ùå Doxyfile not found"; \
    fi

# Quick development cycle (build + test)
quick: build test
    @echo "‚úÖ Quick cycle complete!"

# Full validation (clean + build + all tests + lint)
validate: clean build test-verbose lint
    @echo "‚úÖ Full validation complete!"

# Update dependencies
update-deps:
    platformio pkg update

# List all connected devices
devices:
    platformio device list

# Create test report
test-report:
    @echo "Generating test report..."
    platformio test --json-output-path test_report.json
    @echo "‚úÖ Test report saved to test_report.json"

# Continuous testing (watch mode)
watch:
    @echo "Watching for changes... (Ctrl+C to stop)"
    @while true; do \
        inotifywait -r -e modify src/ include/ test/; \
        clear; \
        just test; \
        sleep 1; \
    done

# Debug build (with debug symbols)
debug-build:
    platformio run --environment esp32dev --build-type debug

# Profile memory usage
memory-profile:
    @platformio run --target size --environment esp32dev
    @echo "\n=== Memory Usage Analysis ==="
    @echo "Run after building to see RAM/Flash usage"

# Backup source code
backup:
    @echo "Creating backup..."
    @tar -czf ../ecowatt_backup_$(date +%Y%m%d_%H%M%S).tar.gz src/ include/ platformio.ini
    @echo "‚úÖ Backup created in parent directory"

# Clean everything including dependencies
distclean: clean
    rm -rf .pio
    @echo "‚úÖ Complete clean done"

# Help message
help:
    @echo "EcoWatt ESP32 Build System"
    @echo ""
    @echo "Common commands:"
    @echo "  just build              - Build firmware"
    @echo "  just upload             - Upload to device"
    @echo "  just test               - Run all tests"
    @echo "  just test-compression   - Test compression only"
    @echo "  just monitor            - Serial monitor"
    @echo "  just validate           - Full validation"
    @echo "  just build-wokwi        - Build for simulator"
    @echo ""
    @echo "Run 'just --list' for all commands"
