# Flask EcoWatt Server Justfile
# Server management and testing automation
# Usage: just <recipe>

# Default recipe - list all commands
default:
    @just --list

# Install Python dependencies
install:
    pip install -r req.txt

# Install development dependencies
install-dev:
    pip install -r req.txt pytest pytest-watch black pylint flake8 mypy

# Start Flask server (development mode)
run:
    python flask_server_hivemq.py

# Start with debug mode enabled
debug:
    FLASK_DEBUG=1 FLASK_ENV=development python flask_server_hivemq.py

# Start in background
run-bg:
    nohup python flask_server_hivemq.py > server.log 2>&1 &
    @echo "Server started in background (PID in server.log)"

# Stop background server
stop:
    @pkill -f flask_server_hivemq.py || echo "Server not running"

# Run unit tests
test:
    python -m pytest tests/ -v

# Run specific test files
test-compression:
    python benchmark_compression.py

test-security:
    python tests/test_security.py

test-protocol:
    python tests/test_protocol.py

test-fota:
    python tests/test_fota.py

# Run all tests with coverage
test-coverage:
    python -m pytest tests/ --cov=. --cov-report=html --cov-report=term

# Run tests in watch mode (auto-rerun on file changes)
test-watch:
    pytest-watch tests/

# Enable fault injection for testing
enable-faults:
    @curl -X POST http://localhost:5000/api/inverter/fault/enable \
        -H "Content-Type: application/json" \
        -d '{"rate": 0.1, "types": ["crc", "truncate", "timeout"]}' \
        && echo "\n✅ Fault injection enabled (10% rate)"

# Disable fault injection
disable-faults:
    @curl -X POST http://localhost:5000/api/inverter/fault/disable \
        && echo "\n✅ Fault injection disabled"

# Check fault injection status
fault-status:
    @curl http://localhost:5000/api/inverter/fault/stats | python -m json.tool

# Check security statistics for device
security-stats device_id="ESP32_EcoWatt_Smart":
    @curl http://localhost:5000/security/stats/{{device_id}} | python -m json.tool

# View diagnostics for device
diagnostics device_id="ESP32_EcoWatt_Smart":
    @curl http://localhost:5000/diagnostics/{{device_id}} | python -m json.tool

# Queue a command to device
queue-command device_id="ESP32_EcoWatt_Smart" command="set_power" value="50":
    @python queue_command_for_esp32.py {{device_id}} {{command}} {{value}}

# Check command queue status
command-status device_id="ESP32_EcoWatt_Smart":
    @curl http://localhost:5000/command/poll \
        -H "Content-Type: application/json" \
        -d '{"device_id": "{{device_id}}"}' | python -m json.tool

# Generate test firmware with bad hash
generate-bad-firmware:
    python prepare_firmware.py --bad-hash

# Generate test firmware with corrupt chunk
generate-corrupt-firmware chunk="5":
    python prepare_firmware.py --corrupt-chunk {{chunk}}

# Clean log files and temporary data
clean:
    rm -f *.log
    rm -f nonce_state.json
    rm -f __pycache__/*.pyc
    rm -rf __pycache__
    @echo "✅ Cleaned log files and cache"

# Format Python code with black
format:
    black *.py tests/

# Lint Python code
lint:
    @echo "Running pylint..."
    pylint *.py --disable=C0111,R0903 || true
    @echo "\nRunning flake8..."
    flake8 *.py --max-line-length=100 --ignore=E203,W503 || true
    @echo "✅ Lint complete"

# Type checking with mypy
typecheck:
    mypy *.py --ignore-missing-imports

# Full validation (lint + typecheck + tests)
validate: lint typecheck test
    @echo "✅ Full validation complete!"

# Start production server with gunicorn
production:
    gunicorn -w 4 -b 0.0.0.0:5000 flask_server_hivemq:app --access-logfile access.log --error-logfile error.log

# Backup data files
backup:
    @echo "Creating backup..."
    @tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz *.json *.log firmware/
    @echo "✅ Backup created"

# View server logs (tail -f)
logs:
    tail -f server.log

# View security audit log
audit-log:
    tail -f security_audit.log

# Run integration tests (requires ESP32 connected/simulated)
integration-test:
    @echo "Running integration tests..."
    python tests/test_integration.py

# Generate RSA keys for FOTA
generate-keys:
    python generate_keys.py

# Verify firmware signature
verify-firmware version="1.0.4":
    python verify_signature.py firmware/firmware_{{version}}_encrypted.bin

# Test security layer with attack simulation
test-attack-simulation:
    @echo "Testing replay attack..."
    python tests/test_security_replay.py
    @echo "\nTesting tampered MAC..."
    python tests/test_security_tamper.py
    @echo "\n✅ Attack simulation complete"

# Monitor MQTT messages
mqtt-monitor:
    @echo "Monitoring MQTT messages on broker.hivemq.com..."
    @echo "Press Ctrl+C to stop"
    mosquitto_sub -h broker.hivemq.com -t "esp32/ecowatt_data" -t "esp32/ecowatt_settings"

# Publish test message to MQTT
mqtt-test-publish topic="esp32/ecowatt_settings" message='{"Changed":true,"pollFreqChanged":true,"newPollTimer":10}':
    mosquitto_pub -h broker.hivemq.com -t "{{topic}}" -m '{{message}}'

# Check Python dependencies
check-deps:
    pip list --outdated

# Update Python dependencies
update-deps:
    pip install --upgrade -r req.txt

# Create virtual environment
venv:
    python3 -m venv venv
    @echo "✅ Virtual environment created"
    @echo "Activate with: source venv/bin/activate"

# Install pre-commit hooks (for git)
install-hooks:
    @echo "Installing pre-commit hooks..."
    @echo "just validate" > .git/hooks/pre-commit
    @chmod +x .git/hooks/pre-commit
    @echo "✅ Pre-commit hook installed"

# Quick test cycle (format + test)
quick: format test
    @echo "✅ Quick cycle complete!"

# Full reset (clean + reinstall)
reset: clean
    pip uninstall -y -r req.txt
    just install
    @echo "✅ Full reset complete"

# Help message
help:
    @echo "EcoWatt Flask Server Build System"
    @echo ""
    @echo "Server Management:"
    @echo "  just run                - Start server"
    @echo "  just debug              - Start with debug"
    @echo "  just stop               - Stop background server"
    @echo ""
    @echo "Testing:"
    @echo "  just test               - Run all tests"
    @echo "  just test-security      - Security tests only"
    @echo "  just validate           - Full validation"
    @echo ""
    @echo "Device Operations:"
    @echo "  just queue-command      - Send command to device"
    @echo "  just diagnostics        - View device diagnostics"
    @echo "  just security-stats     - Security statistics"
    @echo ""
    @echo "Run 'just --list' for all commands"
