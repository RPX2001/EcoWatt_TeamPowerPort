# Flask EcoWatt Server - Task Automation
# Usage: just <command>

# List all available commands
default:
    @just --list

# ============================================================
# Server Management
# ============================================================

# Start Flask server (development mode)
server:
    python flask_server_modular.py

# Start Flask server in background
server-bg:
    nohup python flask_server_modular.py > server.log 2>&1 &
    @echo "✅ Server started in background (see server.log)"

# Stop background server
stop:
    @pkill -f flask_server_modular.py || echo "Server not running"

# View server logs (real-time)
logs:
    tail -f server.log

# ============================================================
# Testing
# ============================================================

# Run all integration tests
test:
    python -m pytest -v

# Run M3 integration tests only (compression, acquisition, upload)
test-m3:
    python -m pytest test_m3_integration/ -v

# Run M4 integration tests only (security, OTA, commands, config)
test-m4:
    python -m pytest test_m4_integration/ -v

# Run tests with coverage report
test-coverage:
    python -m pytest --cov=. --cov-report=html --cov-report=term -v

# ============================================================
# Utilities
# ============================================================

# Generate RSA key pair for FOTA (first-time setup)
generate-keys:
    python generate_keys.py
    @echo "✅ Keys generated in keys/ directory"

# Prepare and sign firmware for OTA update
prepare-firmware version="1.0.5":
    python prepare_firmware.py {{version}}
    @echo "✅ Firmware prepared: firmware/firmware_{{version}}_encrypted.bin"

# Benchmark compression algorithms (SEMANTIC, DICTIONARY, HUFFMAN)
benchmark:
    python benchmark_compression.py

# Queue a command to ESP32 device
queue-command device_id="ESP32_EcoWatt_Smart" command="set_power_percentage" value="60":
    python queue_command_for_esp32.py {{device_id}} {{command}} {{value}}
    @echo "✅ Command queued: {{command}}={{value}}"

# ============================================================
# Maintenance
# ============================================================

# Install Python dependencies
install:
    pip install -r req.txt
    @echo "✅ Dependencies installed"

# Clean temporary files and logs
clean:
    rm -f *.log
    rm -f nonce_state.json
    rm -rf __pycache__
    rm -rf handlers/__pycache__
    rm -rf routes/__pycache__
    rm -rf utils/__pycache__
    rm -rf .pytest_cache
    rm -rf htmlcov
    @echo "✅ Cleaned temporary files"

# ============================================================
# Development
# ============================================================

# Format Python code with black
format:
    black *.py handlers/ routes/ utils/ test_m3_integration/ test_m4_integration/
    @echo "✅ Code formatted"

# Run linter (pylint)
lint:
    pylint *.py handlers/*.py routes/*.py utils/*.py --disable=C0111,R0903 || true
    @echo "✅ Lint complete"

