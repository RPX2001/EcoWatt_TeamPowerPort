# ğŸ—ï¸ Improved System Architecture - Milestones 2-4

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ESP32 EcoWatt Device                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Application Layer                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ Compression  â”‚  â”‚   Security   â”‚  â”‚ Diagnostics  â”‚ [NEW]     â”‚  â”‚
â”‚  â”‚  â”‚   Engine     â”‚  â”‚    Layer     â”‚  â”‚   Module     â”‚           â”‚  â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Delta      â”‚  â”‚ â€¢ HMAC-SHA256â”‚  â”‚ â€¢ Event Log  â”‚           â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ RLE        â”‚  â”‚ â€¢ AES-128    â”‚  â”‚ â€¢ Ring Bufferâ”‚           â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Dictionary â”‚  â”‚ â€¢ Nonce      â”‚  â”‚ â€¢ NVS Persistâ”‚           â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Semantic   â”‚  â”‚ â€¢ Anti-replayâ”‚  â”‚ â€¢ HTTP API   â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                  â”‚                  â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         â”‚   Protocol Adapter Layer [ENHANCED] â”‚                   â”‚  â”‚
â”‚  â”‚         â”‚                  â”‚                  â”‚                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚       Protocol Adapter (Modbus over HTTP)              â”‚      â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Frame Builder                                         â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ CRC Calculator                                        â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Frame Validator âœ¨ NEW                               â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Error Handler (Retry Logic)                          â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Malformed Frame Detection âœ¨ NEW                     â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Timeout Handler                                      â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Auto-Diagnostics Integration âœ¨ NEW                  â”‚      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Driver Layer                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  â”‚
â”‚  â”‚  â”‚ WiFi       â”‚  â”‚   NVS      â”‚  â”‚   Timer    â”‚                â”‚  â”‚
â”‚  â”‚  â”‚ Manager    â”‚  â”‚  Storage   â”‚  â”‚  Manager   â”‚                â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ HTTPS REST API
                                    â”‚ (Secured Payloads)
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Flask Cloud Server                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    API Endpoints                                    â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  /process              - Receive compressed data                    â”‚  â”‚
â”‚  â”‚  /changes              - Configuration updates                      â”‚  â”‚
â”‚  â”‚  /command/poll         - Command polling                            â”‚  â”‚
â”‚  â”‚  /command/result       - Command results                            â”‚  â”‚
â”‚  â”‚  /ota/check            - FOTA version check                         â”‚  â”‚
â”‚  â”‚  /ota/download         - Firmware chunks                            â”‚  â”‚
â”‚  â”‚  /diagnostics          - Device diagnostics âœ¨ NEW                 â”‚  â”‚
â”‚  â”‚  /security/test        - Security testing âœ¨ NEW                   â”‚  â”‚
â”‚  â”‚  /api/inverter/fault   - Fault injection âœ¨ NEW                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Core Modules                                     â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Server Security  â”‚  â”‚ Fault Injector   â”‚  â”‚ Security Tester â”‚ â”‚  â”‚
â”‚  â”‚  â”‚     Layer        â”‚  â”‚  âœ¨ NEW          â”‚  â”‚   âœ¨ NEW        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ HMAC Verify    â”‚  â”‚ â€¢ Corrupt CRC    â”‚  â”‚ â€¢ Replay Test   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Nonce Track    â”‚  â”‚ â€¢ Truncate       â”‚  â”‚ â€¢ Tamper Test   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Persist State  â”‚  â”‚ â€¢ Garbage Gen    â”‚  â”‚ â€¢ MAC Test      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚   âœ¨ NEW         â”‚  â”‚ â€¢ Timeout Sim    â”‚  â”‚ â€¢ Audit Log     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Command Manager  â”‚  â”‚ Firmware Manager â”‚  â”‚ Compression     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚ Validator       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚  âœ¨ NEW         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Queue Cmds     â”‚  â”‚ â€¢ Version Mgmt   â”‚  â”‚                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Track Status   â”‚  â”‚ â€¢ Chunk Delivery â”‚  â”‚ â€¢ Python Impl   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Result Report  â”‚  â”‚ â€¢ Signature Ver  â”‚  â”‚ â€¢ Cross-Validateâ”‚ â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚ â€¢ Fault Inject   â”‚  â”‚ â€¢ Benchmark     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚   âœ¨ NEW         â”‚  â”‚                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Persistence Layer                                â”‚  â”‚
â”‚  â”‚                                                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚ nonce_state  â”‚  â”‚ security     â”‚  â”‚ diagnostics  â”‚            â”‚  â”‚
â”‚  â”‚  â”‚   .json      â”‚  â”‚ _audit.log   â”‚  â”‚   .json      â”‚            â”‚  â”‚
â”‚  â”‚  â”‚  âœ¨ NEW      â”‚  â”‚  âœ¨ NEW      â”‚  â”‚  âœ¨ NEW      â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ HTTP/MQTT
                                      â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   Inverter SIM API         â”‚
                        â”‚   (Modbus Emulator)        â”‚
                        â”‚                            â”‚
                        â”‚ â€¢ Read Registers           â”‚
                        â”‚ â€¢ Write Registers          â”‚
                        â”‚ â€¢ Fault Injection âœ¨ NEW  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow: Milestone 2 (Protocol Enhancement)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ESP32     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Build Modbus Frame
       â”‚    (0x11 0x03 0x00 0x6B 0x00 0x02 CRC)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Protocol Adapter                        â”‚
â”‚  â€¢ Calculate CRC                         â”‚
â”‚  â€¢ Convert to Hex String                 â”‚
â”‚  â€¢ Wrap in JSON {"frame": "11030..."}   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. HTTP POST to Inverter SIM API
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flask Server (Inverter SIM)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Fault Injector âœ¨ NEW            â”‚  â”‚
â”‚  â”‚  â€¢ 10% chance: corrupt CRC         â”‚  â”‚
â”‚  â”‚  â€¢ 5% chance: truncate frame       â”‚  â”‚
â”‚  â”‚  â€¢ 2% chance: return garbage       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Return Response (possibly corrupted)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Protocol Adapter - parseResponse()      â”‚
â”‚  âœ¨ NEW Validation Steps:               â”‚
â”‚  â€¢ Check hex string format               â”‚
â”‚  â€¢ Validate frame length                 â”‚
â”‚  â€¢ Recalculate CRC, compare              â”‚
â”‚  â€¢ Check exception codes                 â”‚
â”‚                                          â”‚
â”‚  If VALID:                               â”‚
â”‚    â†’ Extract data                        â”‚
â”‚    â†’ Log success to Diagnostics          â”‚
â”‚    â†’ Return data                         â”‚
â”‚                                          â”‚
â”‚  If INVALID:                             â”‚
â”‚    â†’ Log error type to Diagnostics       â”‚
â”‚    â†’ Increment error counter (NVS)       â”‚
â”‚    â†’ Retry (up to 3 times)               â”‚
â”‚    â†’ If all retries fail: return error   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Diagnostics Module âœ¨ NEW               â”‚
â”‚  â€¢ Ring Buffer: [Event1, Event2, ...]   â”‚
â”‚  â€¢ NVS Counters:                         â”‚
â”‚    - read_errors: 5                      â”‚
â”‚    - write_errors: 2                     â”‚
â”‚    - crc_errors: 3                       â”‚
â”‚    - timeouts: 1                         â”‚
â”‚  â€¢ HTTP Endpoint: GET /diagnostics       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—œï¸ Data Flow: Milestone 3 (Compression Validation)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ESP32     â”‚
â”‚ Test Mode   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Load Test Dataset
       â”‚    [2434, 179, 70, 4087, 72, 620] Ã— 5 samples
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Compression Test Suite âœ¨ NEW           â”‚
â”‚                                          â”‚
â”‚  For each method (DELTA, RLE, DICT):    â”‚
â”‚    â€¢ Compress dataset                    â”‚
â”‚    â€¢ Measure time                        â”‚
â”‚    â€¢ Calculate sizes                     â”‚
â”‚    â€¢ Decompress result                   â”‚
â”‚    â€¢ Verify 100% match                   â”‚
â”‚    â€¢ Calculate ratios:                   â”‚
â”‚      - Original: 140 bytes               â”‚
â”‚      - Compressed: 5 bytes               â”‚
â”‚      - Ratio: 28:1                       â”‚
â”‚      - Savings: 96.4%                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Send results to Flask
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flask - Compression Validator âœ¨ NEW    â”‚
â”‚                                          â”‚
â”‚  â€¢ Receive ESP32 results                 â”‚
â”‚  â€¢ Run Python implementation             â”‚
â”‚  â€¢ Compare byte-by-byte:                 â”‚
â”‚    - ESP32 output: [0x44, 0x03, ...]    â”‚
â”‚    - Python output: [0x44, 0x03, ...]   â”‚
â”‚    - Match: âœ… PASS                     â”‚
â”‚  â€¢ Generate comparison report            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Data Flow: Milestone 4 (Security Testing)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ESP32     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Prepare Secured Payload
       â”‚    {
       â”‚      "nonce": 12345,
       â”‚      "payload": "base64data...",
       â”‚      "mac": "hmac_sha256..."
       â”‚    }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Security Layer (ESP32)                  â”‚
â”‚  â€¢ Increment nonce                       â”‚
â”‚  â€¢ Encrypt payload (optional)            â”‚
â”‚  â€¢ Calculate HMAC-SHA256                 â”‚
â”‚  â€¢ Save nonce to NVS                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Send to Flask
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flask - Security Tester âœ¨ NEW          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Attack Simulation Options:        â”‚  â”‚
â”‚  â”‚  1. Replay: Resend old payload     â”‚  â”‚
â”‚  â”‚  2. Tamper: Flip bits in MAC       â”‚  â”‚
â”‚  â”‚  3. Old Nonce: Use nonce < last    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Forward to Security Layer
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server Security Layer (Enhanced)        â”‚
â”‚                                          â”‚
â”‚  Step 1: Load nonce_state.json          â”‚
â”‚    {                                     â”‚
â”‚      "ESP32_1": {                        â”‚
â”‚        "last_nonce": 12344,              â”‚
â”‚        "total_valid": 450,               â”‚
â”‚        "total_rejected": 5               â”‚
â”‚      }                                   â”‚
â”‚    }                                     â”‚
â”‚                                          â”‚
â”‚  Step 2: Check nonce                     â”‚
â”‚    if nonce <= last_nonce:               â”‚
â”‚      â†’ REJECT (Replay Attack)            â”‚
â”‚      â†’ Log to security_audit.log         â”‚
â”‚      â†’ Increment total_rejected          â”‚
â”‚                                          â”‚
â”‚  Step 3: Verify HMAC                     â”‚
â”‚    calculated_mac = hmac_sha256(...)     â”‚
â”‚    if calculated_mac != received_mac:    â”‚
â”‚      â†’ REJECT (Tampered)                 â”‚
â”‚      â†’ Log to security_audit.log         â”‚
â”‚                                          â”‚
â”‚  Step 4: Accept if valid                 â”‚
â”‚    â†’ Update last_nonce = 12345           â”‚
â”‚    â†’ Increment total_valid               â”‚
â”‚    â†’ Save nonce_state.json               â”‚
â”‚    â†’ Process payload                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Module Dependencies

```
ESP32 Modules:
  main.cpp
    â”œâ”€ depends on â†’ compression.cpp
    â”œâ”€ depends on â†’ security.cpp
    â”œâ”€ depends on â†’ diagnostics.cpp âœ¨ NEW
    â”œâ”€ depends on â†’ protocol_adapter.cpp
    â””â”€ depends on â†’ acquisition.cpp

  protocol_adapter.cpp
    â”œâ”€ depends on â†’ diagnostics.cpp âœ¨ NEW (for auto-logging)
    â””â”€ uses â†’ HTTPClient (WiFi)

  diagnostics.cpp âœ¨ NEW
    â”œâ”€ depends on â†’ nvs.cpp (for persistence)
    â””â”€ standalone â†’ no dependencies

Flask Modules:
  flask_server_hivemq.py
    â”œâ”€ depends on â†’ server_security_layer.py
    â”œâ”€ depends on â†’ firmware_manager.py
    â”œâ”€ depends on â†’ command_manager.py
    â”œâ”€ depends on â†’ fault_injector.py âœ¨ NEW
    â””â”€ depends on â†’ security_tester.py âœ¨ NEW

  fault_injector.py âœ¨ NEW
    â””â”€ standalone â†’ no dependencies

  security_tester.py âœ¨ NEW
    â”œâ”€ depends on â†’ server_security_layer.py
    â””â”€ depends on â†’ nonce_state.json

  benchmark_compression.py âœ¨ NEW
    â””â”€ standalone â†’ implements compression in Python
```

---

## âœ… Configuration Hierarchy

```
ESP32:
  platformio.ini
    â””â”€ build_flags = -D ENABLE_DIAGNOSTICS=1
                     -D ENABLE_TESTS=0

  include/config.h (or test_config.h)
    â”œâ”€ Diagnostics Settings
    â”œâ”€ Protocol Adapter Settings
    â”œâ”€ Test Mode Flags
    â””â”€ Security Settings

Flask:
  config.py
    â”œâ”€ Fault Injection Settings
    â”œâ”€ Security Settings
    â”œâ”€ Persistence File Paths
    â””â”€ Test Mode Settings
```

---

**Legend**:
- âœ¨ NEW = New module/feature to be implemented
- [ENHANCED] = Existing module with new features
- â”Œâ”€â” = Component boundary
- â†’ = Data flow direction
- â”œâ”€ = Tree structure / dependency
